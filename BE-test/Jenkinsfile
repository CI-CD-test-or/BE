pipeline {
    agent { label 'jenkins-agent' }

    environment {
        HARBOR_REGISTRY      = '192.168.56.12:30443'   // Harbor HTTPS 주소
        HARBOR_PROJECT       = 'cicd-apps'             // Harbor 프로젝트명
        DOCKER_IMAGE_NAME    = 'backend-app'           // 푸시할 이미지명
        HARBOR_CREDENTIAL_ID = 'harbor-credential'     // Jenkins에 저장한 Harbor 계정
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build with Gradle') {
            steps {
                container('gradle') {
                    dir('BE-test') {
                        sh 'chmod +x gradlew'
                        sh './gradlew build'
                    }
                }
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                container('docker') {
                    script {
                        dir('BE-test') {
                            withCredentials([usernamePassword(
                                credentialsId: HARBOR_CREDENTIAL_ID,
                                usernameVariable: 'HARBOR_USER',
                                passwordVariable: 'HARBOR_PASS'
                            )]) {
                                def imageTag      = "${DOCKER_IMAGE_NAME}:${BUILD_NUMBER}"
                                def fullImageName = "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${imageTag}"

                                // ✅ Harbor 로그인 (Self-signed 인증서 무시)
                                sh """
                                    echo "${HARBOR_PASS}" | docker login https://${HARBOR_REGISTRY} \
                                      -u "${HARBOR_USER}" --password-stdin || exit 1
                                """

                                // ✅ Docker Build & Push
                                sh "docker build -t ${fullImageName} ."
                                sh "docker push ${fullImageName}"
                            }
                        }
                    }
                }
            }
        }
    }
}
