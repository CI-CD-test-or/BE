pipeline {
    // 1. Pod 템플릿 지정 및 옵션 추가
    agent { label 'jenkins-agent' }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10')) // 빌드 기록은 최신 10개만 유지
        disableConcurrentBuilds()                      // 동시에 여러 빌드가 실행되지 않도록 방지
        timeout(time: 30, unit: 'MINUTES')             // 빌드 타임아웃 30분 설정
    }

    // 2. 환경 변수 재구성
    environment {
        HARBOR_REGISTRY      = '192.168.56.12:30443'
        HARBOR_PROJECT       = 'cicd-apps'
        DOCKER_IMAGE_NAME    = 'backend-app'
        HARBOR_CREDENTIAL_ID = 'harbor-credential'
        PROJECT_DIR          = 'BE-test' // 소스 코드 디렉터리를 변수로 관리
    }

    stages {
        stage('Checkout') {
            steps {
                // Workspace를 정리하여 이전 빌드의 영향 제거
                cleanWs()
                checkout scm
            }
        }

        stage('Build with Gradle') {
            steps {
                container('gradle') {
                    dir(PROJECT_DIR) {
                        sh 'chmod +x gradlew'
                        sh './gradlew build --no-daemon'
                    }
                }
            }
        }

        stage('Build and Push with Kaniko') {
            steps {
                container('kaniko') {
                    script {
                        withCredentials([usernamePassword(
                            credentialsId: HARBOR_CREDENTIAL_ID,
                            usernameVariable: 'HARBOR_USER',
                            passwordVariable: 'HARBOR_PASS'
                        )]) {
                            // Harbor 인증을 위한 config.json 생성
                            sh """
                                echo '{"auths":{"${HARBOR_REGISTRY}":{"username":"${HARBOR_USER}","password":"${HARBOR_PASS}"}}}' > /kaniko/.docker/config.json
                            """
                            
                            // Kaniko 실행
                            sh """
                                /kaniko/executor \\
                                    --context \$(pwd)/${PROJECT_DIR} \\
                                    --dockerfile \$(pwd)/${PROJECT_DIR}/Dockerfile \\
                                    --destination ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${DOCKER_IMAGE_NAME}:${BUILD_NUMBER} \\
                                    --cache=true --cache-repo ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/cache \\
                                    --registry-certificate ${HARBOR_REGISTRY}=/usr/local/share/ca-certificates/harbor/harbor.crt
                            """
                        }
                    }
                }
            }
        }
    }

    // 빌드 후 정리 작업 (성공/실패 여부와 관계없이 항상 실행)
    post {
        always {
            cleanWs()
            echo 'Pipeline finished. Workspace cleaned up.'
        }
    }
}
