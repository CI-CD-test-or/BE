pipeline {
    agent { label 'jenkins-agent' }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timeout(time: 30, unit: 'MINUTES')
    }

    environment {
        HARBOR_REGISTRY      = '192.168.56.12:30443'
        HARBOR_PROJECT       = 'cicd-apps'
        DOCKER_IMAGE_NAME    = 'backend-app'
        HARBOR_CREDENTIAL_ID = 'harbor-credential'
        PROJECT_DIR          = 'BE-test'
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
            }
        }

        stage('Build with Gradle') {
            steps {
                container('gradle') {
                    // ✅ [최적화] Gradle 캐시를 재적용하여 의존성 다운로드 시간을 단축합니다.
                    // (Pipeline Caching Directive Plugin 설치 필요)
                    cache(path: '/home/jenkins/.gradle/caches', key: "gradle-${(env.BRANCH_NAME ?: 'main').replaceAll('/', '-')}") {
                        dir(PROJECT_DIR) {
                            sh 'chmod +x gradlew'
                            sh './gradlew build --no-daemon'
                        }
                    }
                }
            }
        }

        stage('Build and Push with Kaniko') {
            steps {
                container('kaniko') {
                    script {
                        withCredentials([usernamePassword(
                            credentialsId: HARBOR_CREDENTIAL_ID,
                            usernameVariable: 'HARBOR_USER',
                            passwordVariable: 'HARBOR_PASS'
                        )]) {
                            sh """
                                echo '{"auths":{"${HARBOR_REGISTRY}":{"username":"${HARBOR_USER}","password":"${HARBOR_PASS}"}}}' > /kaniko/.docker/config.json
                            """

                            // ✅ [최적화] TLS 검증 건너뛰기 옵션은 그대로 유지합니다.
                            sh """
                                /kaniko/executor \\
                                    --context \$(pwd)/${PROJECT_DIR} \\
                                    --dockerfile \$(pwd)/${PROJECT_DIR}/Dockerfile \\
                                    --destination ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${DOCKER_IMAGE_NAME}:${BUILD_NUMBER} \\
                                    --cache=true --cache-repo ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/cache \\
                                    --skip-tls-verify
                            """
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
            echo 'Pipeline finished. Workspace cleaned up.'
        }
    }
}
