pipeline {
    agent any

    environment {
        HARBOR_REGISTRY = '192.168.56.12:30080'
        HARBOR_PROJECT = 'library' 
        DOCKER_IMAGE_NAME = 'backend-app'
        HARBOR_CREDENTIAL_ID = 'harbor-credential'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                dir('BE-test') {    // üìå BE-test ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
                    sh './gradlew build'
                }
            }
        }

        stage('Build and Push Image') {
            steps {
                script {
                    dir('BE-test') {  // üìå BE-test ÎîîÎ†âÌÜ†Î¶¨ÏóêÏÑú Docker ÎπåÎìú Ïã§Ìñâ
                        withCredentials([usernamePassword(credentialsId: HARBOR_CREDENTIAL_ID, usernameVariable: 'HARBOR_USER', passwordVariable: 'HARBOR_PASS')]) {
                            def imageTag = "${DOCKER_IMAGE_NAME}:${BUILD_NUMBER}"
                            def fullImageName = "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${imageTag}"

                            sh "docker login -u ${HARBOR_USER} -p ${HARBOR_PASS} ${HARBOR_REGISTRY}"
                            sh "docker build -t ${fullImageName} ."
                            sh "docker push ${fullImageName}"
                        }
                    }
                }
            }
        }
    }
}
