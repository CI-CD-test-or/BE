pipeline {
    agent { label 'jenkins-agent' }

    environment {
        HARBOR_REGISTRY      = '192.168.56.12:30443'
        HARBOR_PROJECT       = 'cicd-apps'
        DOCKER_IMAGE_NAME    = 'backend-app'
        HARBOR_CREDENTIAL_ID = 'harbor-credential'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build with Gradle') {
            steps {
                container('gradle') {
                    dir('BE-test') {
                        sh 'chmod +x gradlew'
                        sh './gradlew build'
                    }
                }
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                container('docker') {
                    script {
                        dir('BE-test') {
                            withCredentials([usernamePassword(
                                credentialsId: HARBOR_CREDENTIAL_ID,
                                usernameVariable: 'HARBOR_USER',
                                passwordVariable: 'HARBOR_PASS'
                            )]) {
                                def imageTag      = "${DOCKER_IMAGE_NAME}:${BUILD_NUMBER}"
                                def fullImageName = "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${imageTag}"

                                // ✅ 인증서 무시 (--tls-verify=false)
                                sh """
                                  echo "${HARBOR_PASS}" | docker login ${HARBOR_REGISTRY} \
                                    -u "${HARBOR_USER}" --password-stdin --tls-verify=false
                                """
                                sh "docker build -t ${fullImageName} ."
                                sh "docker push ${fullImageName}"
                            }
                        }
                    }
                }
            }
        }
    }
}
